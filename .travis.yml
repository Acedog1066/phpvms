#
#

language: php
php:
  - '7.0'
  - '7.1'
  - '7.2'
  - nightly

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.npm

#env:
#  - DB=mysql
#  - DB=mariadb

services:
  - mysql
  - redis-server

addons:
  ssh_known_hosts: phpvms.net

jobs:
  include:
    - stage: All tests
      before_script:
        - cp .travis/env.travis.php env.php
        - composer install --no-interaction --verbose
      script:
        - php artisan database:create --reset
        - php artisan migrate:refresh --seed
        - cp .travis/phpunit.travis.xml phpunit.xml
        - vendor/bin/phpunit --debug --verbose
      after_failure:
        - cat storage/logs/*.log
    - stage: deploy
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_6ae8173eef05_key -iv $encrypted_6ae8173eef05_iv -in .travis/deploy_rsa.enc -out /tmp/deploy_rsa -d
        - eval "$(ssh-agent -s)"
        - chmod 600 /tmp/deploy_rsa
        - ssh-add /tmp/deploy_rsa
      deploy:
        provider: script
        skip_cleanup: true
        script: ./.travis/deploy_script.sh
        on:
            branch: master
            #condition: $DB = mysql
            php: '7.0'
