language: php
php:
  - '7.0'
  - '7.1'
  - '7.2'
  - nightly

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.npm

services:
  - mysql
  - redis-server

addons:
  ssh_known_hosts: phpvms.net

before_script:
  - cp .travis/env.travis.php env.php
  - composer install --no-interaction --verbose

script:
  - php artisan database:create --reset
  - php artisan migrate:refresh --seed
  - cp .travis/phpunit.travis.xml phpunit.xml
  - vendor/bin/phpunit --debug --verbose

after_failure:
  - cat storage/logs/*.log

jobs:
  include:
    - stage: deploy
      script: skip
      before_deploy:
        - curl -sL https://raw.githubusercontent.com/travis-ci/artifacts/master/install | bash
      deploy:
        provider: script
        skip_cleanup: true
        script: ./.travis/deploy_script.sh
        on:
            branch: master
            php: '7.0'
